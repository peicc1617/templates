<html>
<head>
    <title>创新方法工作平台</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="description" content="overview &amp; stats"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <link rel="stylesheet" href="/webresources/ace-master/assets/css/jquery-ui.min.css"/>
    <link rel="stylesheet" href="/webresources/ace-master/assets/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/webresources/ace-master/assets/css/ace.min.css"/>
    <link href="/webresources/bootstrap/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/webresources/ace-master/assets/font-awesome/4.5.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="/webresources/ace-master/assets/css/ace-rtl.min.css"/>
    <link rel="stylesheet" href="/webresources/ace-master/assets/css/ace-skins.min.css"/>
    <link rel="stylesheet" href="css/step.css">
    <link rel="stylesheet" href="/webresources/bootstrap/bootstrap-table/bootstrap-table.css">

    <link rel="stylesheet" href="/webresources/bootstrap/bootstrap3-editable/css/bootstrap-editable.css">
    <link rel="stylesheet" href="css/step.css">
    <script src="assets/js/projectID.js"></script>

    <script>
        //首先获取ID
        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]);
            return null;
        }

        PROJECT_ID = parseInt(getQueryString("projectID"));
        //解析projectID，
        if (isNaN(PROJECT_ID)) {
            //如果解析出错误
            alert("参数错误");//后续跳转
        }
        var ANALYSIS_MSG = {
            projectID: PROJECT_ID,
            type: 0,
            content: ""
        };
        const MSG_TYPE_TABLE = {
            "PROJECT": 1,
            "NODE": 2,
            "USER": 3,
            "RESULT": 4
        }
        const STATE_ERROR = {
            button: {
                style: "btn-danger",
                text: "错误",
            },
            li: []
        }
        const STATE_DIV = {
            "0": {
                button: {
                    style: "btn-light",
                    text: "待绑定",
                },
            },
            "1": {
                button: {
                    style: "btn-grey",
                    text: "待审阅",
                },
                li: [
                    {text: "接受", state: 3},
                    {text: "待修改", state: 2},
                ]
            },
            "2": {
                button: {
                    style: "btn-warning",
                    text: "待修改"
                },
                li: [
                    {text: "接受", state: 3},
                ]
            },
            "3": {
                button: {
                    style: "btn-success",
                    text: "已接受"
                },
                li: [
                    {text: "待修改", state: 2},
                ]
            },
        };
    </script>
</head>
<body class="no-skin">
<div id="navbarDiv" class="navbar navbar-default ace-save-state navbar-fixed-top">
    <div class="navbar navbar-default" id="navbarHtml">
        <div class="navbar-container" id="navbar-container">
            <button type="button" class="navbar-toggle menu-toggler pull-left" id="menu-toggler"
                    data-target="#sidebarDiv">
                <span class="sr-only">Toggle sidebar</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <div class="navbar-header pull-left">
                <a id="href0" href="http://innovation.xjtu.edu.cn/" class="navbar-brand">
                    <small>
                        <i class="fa fa-leaf"></i>小微企业多创新方法融合与集成应用平台
                    </small>
                </a>
                <a id="href1" href="#" class="navbar-brand">
                    <small>
                        <small class="showAppNameDiv">创新方法柔性模板</small>
                    </small>
                </a>
            </div>
            <div class="navbar-header pull-right" role="navigation">
                <ul class="nav ace-nav" style="height: 20px;">
                    <li class="grey">
                        <a id="href2" data-toggle="dropdown" href="&lt;%=basePath%&gt;appList" onclick="gotoHref(this)"
                           class="dropdown-toggle">
                            <img class="nav-user-photo" type="text/javascript"
                                 src="/webresources/ace-master/assets/images/avatars/platform.png" alt="平台首页"> 平台主页
                        </a>
                    </li>
                    <li class="purple">
                        <a href="#" onclick="gotoHref(this)">
                            <img class="nav-user-photo" type="text/javascript"
                                 src="/webresources/ace-master/assets/images/avatars/process.png" alt="模板层"> 模板层
                        </a>
                    </li>
                    <li class="green">
                        <a data-toggle="dropdown" href="#" class="dropdown-toggle">
                            <img class="nav-user-photo" type="text/javascript"
                                 src="/webresources/ace-master/assets/images/avatars/tool.png" alt="工具集"> 工具集

                        </a>
                    </li>
                    <li class="light-blue">
                        <a data-toggle="dropdown" href="#" class="dropdown-toggle">
                            <img id="userAvatar" class="nav-user-photo" type="text/javascript"
                                 src="/webresources/ace-master/assets/images/avatars/avatar2.png"
                                 alt="用户头像">
                            <span class="user-info">
                                    <small>欢迎光临,</small>
                                    <span id="userName">111</span>
                                </span>
                            <i class="icon-caret-down"></i>
                        </a>
                        <ul id="userDropDown"
                            class="user-menu pull-right dropdown-menu dropdown-yellow dropdown-caret dropdown-close">
                            <li>
                                <a href="#" onclick="gotoUserInfo()">
                                    <i class="icon-user"></i> 个人资料</a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a href="#" onclick="logout()" style="cursor:pointer;">
                                    <i class="icon-off"></i> 退出</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="main-container ace-save-state" id="main-container">
    <script type="text/javascript">
        try {
            ace.settings.loadState('main-container')
        } catch (e) {
        }
    </script>
    <div id="sidebar" class="sidebar                  responsive     ace-save-state sidebar-fixed" data-sidebar="true"
         data-sidebar-scroll="true"
         data-sidebar-hover="true">
        <script type="text/javascript">
            try {
                ace.settings.loadState('sidebar')
            } catch (e) {
            }
        </script>

        <div class="sidebar-shortcuts" id="sidebar-shortcuts">
            <div class="sidebar-shortcuts-large" id="sidebar-shortcuts-large">
                <button class="btn btn-success">
                    <i class="ace-icon fa fa-signal"></i>
                </button>

                <button class="btn btn-info">
                    <i class="ace-icon fa fa-pencil"></i>
                </button>

                <button class="btn btn-warning">
                    <i class="ace-icon fa fa-users"></i>
                </button>

                <button class="btn btn-danger">
                    <i class="ace-icon fa fa-cogs"></i>
                </button>
            </div>

            <div class="sidebar-shortcuts-mini" id="sidebar-shortcuts-mini">
                <span class="btn btn-success"></span>

                <span class="btn btn-info"></span>

                <span class="btn btn-warning"></span>

                <span class="btn btn-danger"></span>
            </div>
        </div>
        <!-- /.sidebar-shortcuts -->
        <ul class="nav nav-list" id="sideList">
        </ul>
        <!-- /.nav-list -->

        <div class="sidebar-toggle sidebar-collapse" id="sidebar-collapse">
            <i id="sidebar-toggle-icon" class="ace-save-state ace-icon fa fa-angle-double-left"
               data-icon1="ace-icon fa fa-angle-double-left"
               data-icon2="ace-icon fa fa-angle-double-right"></i>
        </div>
    </div>
    <div class="main-content">

        <div class="main-content-inner">
            <div class="breadcrumbs ace-save-state breadcrumbs-fixed" id="breadcrumbs">
                <ul class="breadcrumb">
                    <li>
                        <i class="ace-icon fa fa-home home-icon"></i>
                        <a href="#">创新方法工具平台</a>
                    </li>

                    <li>
                        <a href="#">柔性模板</a>
                    </li>
                </ul>
                <!-- /.breadcrumb -->
            </div>

            <div class="page-content">
                <div class="page-header">
                    <h1>
                        柔性模板
                        <small>
                            <i class="ace-icon fa fa-angle-double-right"></i>
                            <strong id="project_name"></strong>
                            <div class="pull-right">
                 <span class="btn btn-sm "
                       onclick="javascript:location ='/CAI-templates/manager.html?projectID='+PROJECT_ID">
															进入项目
															<i class="ace-icon fa fa-signal"></i>
														</span>
                                <span class="btn btn-primary btn-sm tooltip-primary"
                                      onclick="javascript:location ='/CAI-templates/info.html?projectID='+PROJECT_ID">
															项目信息
															<i class="ace-icon fa fa-lightbulb-o"></i>
														</span>
                                <span class="btn btn-purple btn-sm tooltip-purple"
                                      onclick="javascript:location ='/CAI-templates/report.html?projectID='+PROJECT_ID">
															导出报告
															<i class="ace-icon fa fa-print"></i>
														</span>
                            </div>
                        </small>
                    </h1>
                </div>
                <!-- /.ace-settings-box -->
                <div class="row">
                    <div class="col-xs-12 col-sm-12">
                        <div class="center">
												<span class="btn btn-app btn-sm btn-light no-hover">
													<span class="line-height-1 bigger-170 blue"
                                                          id="project-times"></span>

													<br>
													<span class="line-height-1 smaller-90"> 访问次数 </span>
												</span>

                            <span class="btn btn-app btn-sm btn-yellow no-hover">
													<span class="line-height-1 bigger-170" id="project-user-num"></span>

													<br>
													<span class="line-height-1 smaller-90"> 用户数目 </span>
												</span>

                            <span class="btn btn-app btn-sm btn-pink no-hover">
													<span class="line-height-1 bigger-170" id="project-step-num"></span>

													<br>
													<span class="line-height-1 smaller-90"> 阶段数目 </span>
												</span>

                            <span class="btn btn-app btn-sm btn-grey no-hover">
													<span class="line-height-1 bigger-170"
                                                          id="project-integration"></span>

													<br>
													<span class="line-height-1 smaller-90"> 集成度 </span>
												</span>

                            <span class="btn btn-app btn-sm btn-success no-hover">
													<span class="line-height-1 bigger-170"
                                                          id="project-amalgamation"></span>

													<br>
													<span class="line-height-1 smaller-90"> 融合度 </span>
												</span>

                            <span class="btn btn-app btn-sm btn-primary no-hover">
													<span class="line-height-1 bigger-170"
                                                          id="project-value"> 55 </span>

													<br>
													<span class="line-height-1 smaller-90"> 应用效果 </span>
												</span>
                        </div>

                        <div class="space-12"></div>

                        <div class="profile-user-info profile-user-info-striped">
                            <div class="profile-info-row">
                                <div class="profile-info-name"> 项目名</div>

                                <div class="profile-info-value">
                                    <span class="editable editable-click"
                                          id="project-name"></span>
                                </div>
                            </div>
                            <div class="profile-info-row">
                                <div class="profile-info-name"> 项目描述</div>
                                <div class="profile-info-value">
                                    <span class="editable editable-click"
                                          id="project-description"></span>
                                </div>
                            </div>
                            <div class="profile-info-row">
                                <div class="profile-info-name"> 项目标签</div>
                                <div class="profile-info-value">
                                    <input type="text" name="project-tags" id="project-tags"
                                           placeholder="Enter tags ..."/>
                                </div>
                            </div>
                            <div class="profile-info-row">
                                <div class="profile-info-name"> 创建时间</div>

                                <div class="profile-info-value">
                                    <span id="project-createTime"></span>
                                </div>
                            </div>

                            <div class="profile-info-row">
                                <div class="profile-info-name"> 上次修改时间</div>

                                <div class="profile-info-value">
                                    <span id="project-editTime"></span>
                                </div>
                            </div>
                            <div class="profile-info-row">
                                <div class="profile-info-name">创建人</div>
                                <div class="profile-info-value">
                                    <span id="project-creator"></span>
                                </div>
                            </div>
                            <div class="profile-info-row">
                                <div class="profile-info-name">删除项目</div>
                                <div class="profile-info-value">
                                    <a onclick="deleteProject()"><span class="red">删除</span></a>
                                </div>
                            </div>
                        </div>

                        <div class="space-20"></div>

                        <div class="widget-box transparent">
                            <div class="widget-header widget-header-small">
                                <h4 class="widget-title blue smaller">
                                    <i class="ace-icon fa fa-rss orange"></i>
                                    项目成员
                                </h4>

                                <div class="widget-toolbar">
                                    <a onclick="javascript:location='member.html?projectID='+PROJECT_ID">
                                        <span class="badge badge-info">用户管理</span>
                                    </a>

                                </div>
                            </div>

                            <div class="widget-body">
                                <div class="widget-main padding-8">
                                    <div class="clearfix" id="person-div">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="space-20"></div>

                        <div class="widget-box transparent">
                            <div class="widget-header widget-header-small">
                                <h4 class="widget-title blue smaller">
                                    <i class="ace-icon fa fa-rss orange"></i>
                                    项目统计
                                </h4>
                            </div>

                            <div class="widget-body">
                                <div class="widget-main padding-8">
                                    <div class="row">
                                    </div>


                                </div>
                            </div>
                        </div>
                        <div class="space-20"></div>

                        <div class="widget-box transparent">
                            <div class="widget-header widget-header-small">
                                <h4 class="widget-title blue smaller">
                                    <i class="ace-icon fa fa-rss orange"></i>
                                    最近活动
                                </h4>
                            </div>

                            <div class="widget-body">
                                <div class="widget-main padding-8">
                                    <div class="row">
                                    </div>


                                </div>
                            </div>
                        </div>


                    </div>

                </div>

            </div>
            <!-- /.page-content -->
        </div>
        <!-- /.main-content -->

        <a href="#" id="btn-scroll-up" class="btn-scroll-up btn btn-sm btn-inverse">
            <i class="ace-icon fa fa-angle-double-up icon-only bigger-110"></i>
        </a>
        <script type="text/javascript" src="/webresources/ace-master/assets/js/jquery-2.1.4.min.js"></script>
        <script type="text/javascript" src="/webresources/ace-master/assets/js/ace.min.js"></script>
        <script type="text/javascript" src="/webresources/ace-master/assets/js/ace-extra.min.js"></script>
        <script type="text/javascript" src="/webresources/ace-master/assets/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="/webresources/ace-master/assets/js/ace-elements.min.js"></script>
        <script src="/webresources/ace-master/assets/js/jquery-ui.min.js"></script>
        <script src="/webresources/bootstrap/bootstrap-table/bootstrap-table.js"></script>
        <script src="/webresources/bootstrap/bootstrap-table/locale/bootstrap-table-zh-CN.js"></script>
        <script src="/webresources/bootstrap/bootstrap3-editable/js/bootstrap-editable.min.js"></script>
        <script src="/webresources/bootstrap/bootstrap-table/extensions/editable/bootstrap-table-editable.js"></script>
        <script src="/webresources/common/js/userLogin.js"></script>
        <script src="/webresources/common/js/nav-list.js"></script>

        <script src="/webresources/common/js/analysis.js"></script>

        <script>
            $(function () {

                $("#project-name").editable({
                    type: 'text',
                    title: '输入工程名',
                    url: updateProject,
                    validate: function (value) { //字段验证
                        if (!$.trim(value)) {
                            return '不能为空';
                        }
                    },

                })
                $("#project-description").editable({
                    type: 'textarea',
                    title: '输入工程描述',
                    validate: function (value) { //字段验证
                        if (!$.trim(value)) {
                            return '不能为空';
                        }
                    },
                    url: updateProject,
                })
                var tag_input = $('#project-tags');
                try {
                    tag_input.tag(
                        {
                            placeholder: tag_input.attr('placeholder'),
                            //enable typeahead by specifying the source array
                            source: ace.vars['US_STATES'],//defined in ace.js >> ace.enable_search_ahead
                            /**
                             //or fetch data from database, fetch those that match "query"
                             source: function(query, process) {
						  $.ajax({url: 'remote_source.php?q='+encodeURIComponent(query)})
						  .done(function(result_items){
							process(result_items);
						  });
						}
                             */
                        }
                    )

                    //programmatically add/remove a tag
                    var $tag_obj = $('#project-tags').data('tag');
                    $tag_obj.add('质量问题');

                    var index = $tag_obj.inValues('some tag');
                    $tag_obj.remove(index);
                }
                catch (e) {
                    //display a textarea for old IE, because it doesn't support this plugin or another one I tried!
                    tag_input.after('<textarea id="' + tag_input.attr('id') + '" name="' + tag_input.attr('name') + '" rows="3">' + tag_input.val() + '</textarea>').remove();
                    //autosize($('#form-field-tags'));
                }
                $.ajax({
                    url: "/templates/api/project",
                    method: "GET",
                    data: {
                        projectID: PROJECT_ID
                    },
                    success: function (project) {
                        $("#project-times").text(project.times);
                        $("#project-user-num").text(project.members.length);
                        $("#project-step-num").text(project.steps.length);
                        $("#project-integration").text(project.integration);
                        $("#project-amalgamation").text(project.amalgamation);
                        $("#project-value").text(90);
                        $("#project-name").text(project.name);
                        $("#project-description").text(project.description);
                        $("#project-tags").text(project.tags);
                        $("#project-createTime").text(new Date(project.createTime).toLocaleString());
                        $("#project-editTime").text(new Date(project.editTime).toLocaleString());
                        $("#project-creator").text(project.creator);
                        personViewRefresh(project.members);
                    }
                })
                Analysis.message = ANALYSIS_MSG;

            })
            AU_TABLE = {
                'CREATOR': 1,
                'SUPERMANAGER': 2,
                'MEMBER': 3,
            }

            function personViewRefresh(memberList) {
                let personDiv = $("#person-div");
                memberList.filter(memeber => memeber.projectRole > 0).forEach(memeber => {
                    let personSpan = $('<span></span>');
                    switch (memeber.projectRole) {
                        case AU_TABLE.CREATOR:
                            personSpan.addClass('label label-success label-sm arrowed-in')
                                .text('创建者');
                            break;
                        case AU_TABLE.SUPERMANAGER:
                            personSpan.addClass('label label-info label-sm arrowed-in')
                                .text('超级管理员');
                            break;
                        case AU_TABLE.MANAGER:
                            personSpan.addClass('label label-info label-sm arrowed-in')
                                .text('管理员');
                            break;
                        case AU_TABLE.MEMBER:
                            personSpan.addClass('label label-light  label-sm arrowed-in')
                                .text('成员');
                            break;
                    }
                    personDiv.append(
                        $('<div></div>').addClass('itemdiv memberdiv')
                            .append(
                                $('<div></div>').addClass('user')
                                    .append(
                                        $('<img></img>').attr({
                                            'alt': memeber.username,
                                            'src': '/webresources/ace-master/assets/images/avatars/user.jpg'
                                        })
                                    )
                            ).append(
                                $('<div></div>').addClass('body')
                                    .append(
                                        $('<div></div>').addClass('name')
                                            .append(
                                                $('<a></a>').attr({
                                                    'href': '#',
                                                }).text(memeber.username)
                                            )
                                    ).append(
                                    $('<div></div>').append(personSpan)
                                )
                        ))

                })
            }
            function updateProject(params) {
                var d = new $.Deferred();
                if (params.value === 'abc') {
                    return d.reject('error message'); //returning error via deferred object
                } else {
                    data = {
                        _method: "PUT",
                        id:PROJECT_ID
                }
                    data[params.name] = params.value
                    //async saving data in js model
                    $.ajax({
                        url: '/templates/api/project',
                        type: 'PUT',
                        async: true,
                        data: data,
                        success: function () {
                            ANALYSIS_MSG.type = MSG_TYPE_TABLE.PROJECT
                            ANALYSIS_MSG.content = "修改了项目信息[" + params.name + "]：[" + params.value + "]"
                            Analysis.send();
                            d.resolve();
                        }
                    })
                    return d.promise();
                }
            }
            function deleteProject() {
                var name;
                name=prompt("是否确认删除该项目(删除后不可恢复,该项目的所有数据即将清空),请在输入框输入项目全名并点击删除?");
                if(name==="<%=project.getName()%>"){
                    if(confirm("再一次确认")){
                        $.ajax({
                                url:"/CAI-templates/api/project",
                                type:"post",
                                data:{
                                    _method:"DELETE",
                                    id:PROJECT_ID
                            },
                            success:function (data) {
                            alert("删除成功,即将跳转到新建项目页面")
                            window.location.href="/CAI-templates/project"
                        }
                    })
                    }
                }
            }
        </script>

    </div>
</div>
</body>

</html>